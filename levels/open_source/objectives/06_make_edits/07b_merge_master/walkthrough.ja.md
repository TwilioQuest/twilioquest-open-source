# マージをマスターする

## マージとは？

オリジナルのOpen Pixel Artリポジトリからローカルリポジトリにコミットをプルしたときには、すべてがスムーズに行きました。なぜならば、これは、そのブランチ上のファイルを一切変更していないためです。

しかし、新しいピクセルをコミットした際に、ピクセルブランチ`<%= env.TQ_OPEN_PIXEL_ART_BRANCH.value %>`に変更を加えました。Open Pixel Artプロジェクトからあなたがコミットをプルした後に、他ユーザーも新しいピクセルを追加した可能性があります。同じコードに影響を与えるこれらの変更を調整するには、マージプロセスを行う必要があります。

時には、コードをどのようにマージすべきかをgitが自動的に判断してくれることもあります。あるファイルの1行目を私が、200行目をあなたが編集した場合、どちらの変更も最新版のファイルに反映すべきとgitは判断できます。しかし、私が3行目を、あなたが5行目を編集した場合、話はそう単純ではありません。

そのような変更が行われてgitが変更結果を自動的に決定できない場合は、どのコードを最新版のファイルに反映するかを手動で決定する必要があります。このような状況は、マージの競合と呼ばれます。

## 競合

マージの競合に対処するのは時に一苦労です。gitとバージョン管理で一番嫌なことは何かを開発者に聞けば、「マージの競合を解決することです」という答えが多いでしょう。脅かすつもりはありませんが、超ベテランの開発者でも、このプロセスには苦労しています。本当に大変なのです。

幸い、ここでは`_data/pixels.json`ファイルの1行しか変更していないため、マージの競合の解決はそれよりも簡単です。

このトピックについて詳細に説明するとなると、追加のミッションがもう1つ必要でしょう。GitHubでは、[マージの競合の内容と原因に関するさらに詳しい情報](https://help.github.com/en/articles/about-merge-conflicts)を提供しています。[コマンドラインを使用して競合を解決するための詳しいガイド](https://help.github.com/en/articles/resolving-a-merge-conflict-using-the-command-line)もあります。

## マージの方法

まずはピクセルがある私たちのブランチに戻りましょう。これで、追加したピクセルが`_data/pixels.json`ファイルに戻りました。

```bash
git checkout <%= env.TQ_OPEN_PIXEL_ART_BRANCH.value %>
```

さて、マスターから取得した最新版のコードはもうないため、マージプロセスを始めて、ブランチ`master`を私たちの現在のブランチ`<%= env.TQ_OPEN_PIXEL_ART_BRANCH.value %>`にマージします。

```bash
git merge master
```

マージコマンドを実行したときに、マージの進行に関する出力が大量に表示されたと思います。gitでは、ファイルの自動マージを試みたかどうか、マージの際に競合が発生したかどうかに関するメッセージが表示されます。

`CONFLICT`のメッセージが表示されない場合はラッキーです。手助けなしで、gitはマージを解決することができました。

`git status`コマンドを実行することで、マージの現在の状況に関する情報をさらに取得することができます。これにより、多くの情報が得られます。

手動でマージを解決する必要があること`You have unmerged paths.`を知らせてくれたり、ミスをした場合に備えて、マージを中断するためのコマンド`git merge --abort`を教えてくれたりします。

また、このコマンド実行結果の下部には、まだマージされておらず競合の解決が必要なパスのリストが表示されています。ピクセルを追加したばかりなら、次のようなメッセージが表示されているでしょう: 

```bash
Unmerged paths:
  (use "git add <file>..." to mark resolution)

	both modified:   _data/pixels.json
```

[競合を解決しましょう！](https://help.github.com/en/articles/resolving-a-merge-conflict-using-the-command-line)

マージの競合を解決したら、その解決をコミットし、gitにあなたの最終決定を知らせる必要があります。今回は`-m`をオフにし、gitの自動生成されるマージメッセージを使用できるようにします。

## コミットする

```
git commit
```

このコマンドを実行したときに`error: Committing is not possible because you have unmerged files.`のようなメッセージが表示された場合は、マージはまだ解決していません。

上のメッセージが表示されない場合は、テキストエディタでコミットメッセージを書く必要があります。

コミットメッセージを編集するためにgitが開くツールは、デフォルトではVimです。これはコマンドラインのみのテキストエディタであるため、初めての人には使いづらいかもしれません。このメッセージをVim内に保存するには、いくつかの手順が必要です。

1. まず、`ESC`キーを押してコマンドモードに入ります
2. `:`を入力してコマンドを開始します
3. `w`を入力して変更をファイルに書き込むようVimに指示します
4. `q`を入力して終了するようVimに指示します
5. `ENTER`を押してVimコマンドを実行します

すべてがうまく行けば、Vimの外のターミナルに戻るはずです。

## 確認

最後にもう一度`git status`を実行し、何か問題がないか再度確認しましょう。すべてが最新であることを示す`nothing to commit, working tree clean`のようなメッセージが表示されているはずです。

さらに、`git log`を実行して私たちのマージコミットを確認しましょう。最新のコミットには、コミット用にVimで入力したメッセージが表示されているはずです。自動生成されたメッセージを残しておいた場合は、次のようになります: 

```bash
Merge branch 'master' into <%= env.TQ_OPEN_PIXEL_ART_BRANCH.value %>
```

マスターをブランチ`<%= env.TQ_OPEN_PIXEL_ART_BRANCH.value %>`にマージしたら、右にある[`HACK`]を押します。